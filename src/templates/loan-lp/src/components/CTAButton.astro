---
interface Props {
  text?: string;
  aid: string;
}

const {
  text = 'See My Options →',
  aid,
} = Astro.props;
---

<div class="w-full max-w-sm mx-auto">
  <button
    id="cta-button"
    type="button"
    class="w-full py-4 px-6 text-lg font-bold text-secondary-foreground rounded-[var(--radius)]
           bg-secondary hover:bg-secondary/90
           active:scale-[0.98] transition-all duration-150
           focus:outline-none focus:ring-4 focus:ring-secondary/30
           disabled:opacity-50 disabled:cursor-not-allowed
           shadow-lg shadow-secondary/20"
    aria-label={text}
  >
    {text}
  </button>
  <p id="cta-error" class="mt-2 text-sm text-center text-destructive hidden" role="alert">
    Please enter a valid 5-digit ZIP code first.
  </p>
  <div id="leadsgate-container" class="mt-6 hidden"></div>
</div>

<script is:inline define:vars={{ aid }}>
  (function() {
    var btn = document.getElementById('cta-button');
    var error = document.getElementById('cta-error');
    var container = document.getElementById('leadsgate-container');
    if (!btn) return;
    var loaded = false;
    var clickId = sessionStorage.getItem('click_id') || '';
    var convId = window.__CONVERSION_ID__ || '';
    var fsLabel = window.__FORM_START_LABEL__ || '';
    var fsubLabel = window.__FORM_SUBMIT_LABEL__ || '';
    var fsFired = sessionStorage.getItem('_fs') === '1';

    btn.addEventListener('click', function() {
      var zip = sessionStorage.getItem('zip');
      if (!zip || zip.length !== 5) {
        error.classList.remove('hidden');
        var zi = document.getElementById('zip-input');
        if (zi) zi.focus();
        return;
      }
      error.classList.add('hidden');
      if (window.__pixel) window.__pixel('cta', { zip: zip, amount: sessionStorage.getItem('amount') || '' });
      btn.disabled = true;
      btn.textContent = 'Loading...';
      if (!loaded) loadForm(zip, sessionStorage.getItem('amount') || '', clickId);
    });

    function loadForm(zip, amount, cid) {
      loaded = true;
      container.classList.remove('hidden');
      window._lg_form_init_ = {
        aid: aid,
        template: 'fresh',
        click_id: cid,
        onFormLoad: function() {
          if (!fsFired) {
            fsFired = true;
            sessionStorage.setItem('_fs', '1');
            if (convId && fsLabel && typeof gtag === 'function') {
              gtag('event', 'conversion', { send_to: convId + '/' + fsLabel });
            }
          }
          if (window.__pixel) window.__pixel('fl');
        },
        onStepChange: function(step) {
          if (window.__pixel) window.__pixel('step', { step: step });
        },
        onSubmit: function() {
          if (convId && fsubLabel && typeof gtag === 'function') {
            gtag('event', 'conversion', { send_to: convId + '/' + fsubLabel });
          }
          if (window.__pixel) window.__pixel('fs', { clickid: cid });
        },
        onSuccess: function(response) {
          if (window.__pixel) window.__pixel('success', { clickid: cid, lead_id: response && response.lead_id || '' });
        }
      };
      var s = document.createElement('script');
      s.src = 'https://apikeep.com/form/applicationInit.js';
      s.async = true;
      s.onerror = function() {
        btn.disabled = false;
        btn.textContent = 'See My Options →';
        loaded = false;
        container.classList.add('hidden');
        error.textContent = 'Failed to load form. Please try again.';
        error.classList.remove('hidden');
      };
      document.body.appendChild(s);
    }
  })();
</script>
